<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="css/style.css">
    <!-- Quill.js WYSIWYG 에디터 -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        /* General Admin Styles */
        main { padding: 2rem; }
        .admin-container { max-width: 960px; margin: auto; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 2rem; }
        .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background-color: transparent; font-size: 1.1rem; border-bottom: 3px solid transparent; }
        .tab-link.active { border-bottom-color: #8d6e63; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Form Styles */
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group button { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        form button, #gallery-upload-btn { background-color: #8d6e63; color: white; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; border: none; padding: 0.8rem; border-radius: 4px; width: 100%; }
        form button:hover { background-color: #6d4c41; }
        
        /* Item Lists (Gallery & Products) */
        .item-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; }
        .item-container { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .item-container img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .item-info { padding: 1rem; background-color: #f9f9f9; text-align: left;}
        .item-info h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
        .item-info p { margin: 0; font-size: 0.9rem; color: #666; }
        .item-container .delete-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 1rem; font-weight: bold; line-height: 28px; text-align: center; transition: background-color 0.3s; }
        .item-container .delete-btn:hover { background: #e53935; }

        /* Custom File Input */
        .custom-file-upload-label {
            border: 2px dashed #ddd;
            display: inline-block;
            padding: 1.5rem;
            cursor: pointer;
            background-color: #f9f9f9;
            width: 100%;
            text-align: center;
            color: #666;
            border-radius: 8px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .custom-file-upload-label:hover {
            background-color: #f1f1f1;
            border-color: #8d6e63;
        }
        input[type="file"].visually-hidden {
            display: none;
        }
        .file-name-display {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            margin-bottom: 1rem;
            min-height: 50px;
        }
        .preview-image-container {
            position: relative;
        }
        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        button.preview-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        /* Blog Post Card */
        .blog-post-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .blog-post-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
        }
        .blog-post-info p {
            margin: 0.25rem 0;
            color: #666;
            font-size: 0.9rem;
        }
        .blog-post-actions {
            display: flex;
            gap: 0.75rem;
        }
        .blog-post-actions button {
            width: auto;
            min-width: 70px;
            padding: 0.6rem 1.2rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }
        .edit-btn {
            background-color: #f8f9fa !important;
            color: #495057 !important;
            border: 1px solid #dee2e6 !important;
        }
        .edit-btn:hover {
            background-color: #e9ecef !important;
            border-color: #adb5bd !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .delete-btn {
            background-color: #fff !important;
            color: #dc3545 !important;
            border: 1px solid #dc3545 !important;
        }
        .delete-btn:hover {
            background-color: #dc3545 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220,53,69,0.3);
        }

        /* Loading Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/" class="logo">새벽하우징 - 황토방 풍경 - 관리자</a>
            <nav>
                <a href="/logout" class="btn btn-primary">로그아웃</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="admin-container">
            <div class="tabs">
                <button class="tab-link active" data-tab="gallery-management">갤러리 관리</button>
                <button class="tab-link" data-tab="product-management">상품 관리</button>
                <button class="tab-link" data-tab="blog-management">블로그 관리</button>
                <button class="tab-link" data-tab="agent-management">AI 에이전트</button>
            </div>

            <!-- 갤러리 관리 탭 -->
            <div id="gallery-management" class="tab-content active">
                <h2>갤러리 이미지 업로드</h2>
                <label for="gallery-files-input" class="custom-file-upload-label">
                    클릭하여 여러 이미지 선택
                </label>
                <input type="file" id="gallery-files-input" class="visually-hidden" accept="image/*" multiple>
                <div id="gallery-preview" class="file-name-display"></div>
                <button id="gallery-upload-btn">선택한 이미지들 업로드</button>
                
                <h2 style="margin-top: 3rem;">현재 갤러리</h2>
                <div id="gallery-list" class="item-list"></div>
            </div>

            <!-- 상품 관리 탭 -->
            <div id="product-management" class="tab-content">
                <h2>신규 상품 추가</h2>
                <form id="product-add-form">
                    <div class="form-group"><label for="productName">상품명</label><input type="text" id="productName" name="productName" required></div>
                    <div class="form-group"><label for="productPrice">상품 가격</label><input type="number" id="productPrice" name="productPrice" placeholder="숫자만 입력하세요" required></div>
                    <div class="form-group"><label for="productDescription">상품 설명</label><textarea id="productDescription" name="productDescription" rows="3" required></textarea></div>
                    <div class="form-group">
                        <label for="productImage">상품 이미지</label>
                        <label for="productImage" class="custom-file-upload-label">클릭하여 이미지 선택</label>
                        <input type="file" id="productImage" name="productImage" class="visually-hidden" accept="image/*" required>
                        <div id="product-preview" class="file-name-display"></div>
                    </div>
                    <button type="submit">상품 추가하기</button>
                </form>

                <h2 style="margin-top: 3rem;">현재 상품 목록</h2>
                <div id="product-list" class="item-list"></div>
            </div>

            <!-- 블로그 관리 탭 -->
            <div id="blog-management" class="tab-content">
                <h2>블로그 포스트 작성</h2>
                <form id="blog-add-form">
                    <div class="form-group">
                        <label for="blogTitle">제목</label>
                        <input type="text" id="blogTitle" name="blogTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="blogThumbnail">썸네일 이미지 (선택)</label>
                        <label for="blogThumbnail" class="custom-file-upload-label">클릭하여 썸네일 선택</label>
                        <input type="file" id="blogThumbnail" name="blogThumbnail" class="visually-hidden" accept="image/*">
                        <div id="blog-thumbnail-preview" class="file-name-display"></div>
                    </div>
                    <div class="form-group">
                        <label for="blogContent">본문 내용</label>
                        <div id="blogEditor" style="height: 300px; background: white;"></div>
                    </div>
                    <input type="hidden" id="editingPostId" value="">
                    <button type="submit">포스트 발행하기</button>
                    <button type="button" id="cancelEditBtn" style="display:none; background-color: #999; margin-top: 0.5rem;">취소</button>
                </form>

                <h2 style="margin-top: 3rem;">현재 블로그 포스트</h2>
                <div id="blog-list" style="display: flex; flex-direction: column; gap: 1rem;"></div>
            </div>

            <!-- AI 에이전트 관리 탭 -->
            <div id="agent-management" class="tab-content">
                <h2>블로그 자동 생성 에이전트</h2>
                
                <!-- 에이전트 상태 카드 -->
                <div style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #ddd;">
                    <h3 style="margin-top: 0;">에이전트 상태</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <p style="margin: 0.25rem 0; color: #666;">상태</p>
                            <p id="agent-enabled-status" style="margin: 0.25rem 0; font-weight: bold;"></p>
                        </div>
                        <div>
                            <p style="margin: 0.25rem 0; color: #666;">실행 시간</p>
                            <p id="agent-schedule-time" style="margin: 0.25rem 0; font-weight: bold;"></p>
                        </div>
                        <div>
                            <p style="margin: 0.25rem 0; color: #666;">미사용 주제</p>
                            <p id="agent-unused-topics" style="margin: 0.25rem 0; font-weight: bold;"></p>
                        </div>
                        <div>
                            <p style="margin: 0.25rem 0; color: #666;">마지막 실행</p>
                            <p id="agent-last-run" style="margin: 0.25rem 0; font-weight: bold;"></p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="generate-now-btn" style="width: 100%; background-color: #4caf50;">지금 생성하기</button>
                    </div>
                </div>

                <!-- 주제 추가 폼 -->
                <h2>주제 추가</h2>
                <form id="topic-add-form">
                    <div class="form-group">
                        <label for="topicTitle">주제</label>
                        <input type="text" id="topicTitle" name="topicTitle" placeholder="예: 황토집의 장점과 건강에 미치는 영향" required>
                    </div>
                    <div class="form-group">
                        <label for="topicKeywords">키워드 (쉼표로 구분, 선택사항)</label>
                        <input type="text" id="topicKeywords" name="topicKeywords" placeholder="예: 황토집, 건강, 자연">
                    </div>
                    <button type="submit">주제 추가하기</button>
                </form>

                <!-- 주제 목록 -->
                <h2 style="margin-top: 3rem;">주제 목록</h2>
                <div id="topic-list" style="display: flex; flex-direction: column; gap: 1rem;"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 새벽하우징 - 황토방 풍경. All rights reserved.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const CLOUDINARY_CLOUD_NAME = 'dx0nfuwdt';
        const CLOUDINARY_UPLOAD_PRESET = 'vwzny78k';
        
        // Quill 에디터 초기화
        const quill = new Quill('#blogEditor', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['link', 'image'],
                        ['clean']
                    ],
                    handlers: {
                        image: imageHandler
                    }
                }
            },
            placeholder: '블로그 포스트 내용을 작성하세요...'
        });
        
        // Quill 에디터 이미지 핸들러 (Cloudinary 업로드)
        function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;

                // 이미지 업로드 중 표시
                const range = quill.getSelection(true);
                quill.insertText(range.index, '이미지 업로드 중...');
                quill.setSelection(range.index + 13);

                try {
                    const imageUrl = await uploadToCloudinary(file);
                    
                    // 업로드 중 텍스트 삭제
                    quill.deleteText(range.index, 13);
                    
                    // 이미지 삽입
                    quill.insertEmbed(range.index, 'image', imageUrl);
                    quill.setSelection(range.index + 1);
                } catch (error) {
                    console.error('이미지 업로드 실패:', error);
                    quill.deleteText(range.index, 13);
                    alert('이미지 업로드에 실패했습니다.');
                }
            };
        }

        // --- Helper Functions ---
        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) {
                    console.error('Cloudinary upload failed:', data);
                    throw new Error(data.error.message);
                }
                return data.secure_url;
            } catch (error) {
                console.error('Error uploading to Cloudinary:', error);
                alert('이미지 업로드에 실패했습니다. 자세한 내용은 콘솔을 확인해주세요.');
                throw error; // 에러를 다시 던져서 후속 처리를 중단
            }
        };

        // --- Tab AÇTIRMA ---
        const tabs = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // --- Gallery Management ---
        const galleryList = document.getElementById('gallery-list');
        const galleryUploadBtn = document.getElementById('gallery-upload-btn');
        const galleryFilesInput = document.getElementById('gallery-files-input');
        const galleryPreview = document.getElementById('gallery-preview');
        let galleryFiles = [];

        async function loadGallery() {
            const res = await fetch('/api/images');
            const images = await res.json();
            galleryList.innerHTML = '';
            images.forEach(img => {
                galleryList.innerHTML += `<div class="item-container"><img src="${img.url}"><button class="delete-btn" data-type="image" data-public-id="${img.public_id}">&times;</button></div>`;
            });
        }

        galleryUploadBtn.addEventListener('click', async () => {
            if (galleryFiles.length === 0) return alert('업로드할 파일을 선택해주세요.');
            
            galleryUploadBtn.innerHTML = '<span class="spinner"></span>';
            galleryUploadBtn.disabled = true;

            try {
                for (const file of galleryFiles) {
                    const cloudinaryRes = await uploadToCloudinary(file);
                    const res = await fetch('/api/images', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: cloudinaryRes.secure_url, public_id: cloudinaryRes.public_id })
                    });
                    
                    if (!res.ok) {
                        console.error('Failed to save image to server.', await res.text());
                        alert('이미지 정보를 서버에 저장하는데 실패했습니다.');
                    }
                }
            } catch (error) {
                console.error('An error occurred during gallery upload process.');
            } finally {
                galleryFilesInput.value = '';
                galleryFiles = [];
                galleryPreview.innerHTML = '';
                galleryUploadBtn.textContent = '선택한 이미지들 업로드';
                galleryUploadBtn.disabled = false;
                loadGallery();
            }
        });

        // --- Product Management ---
        const productList = document.getElementById('product-list');
        const productForm = document.getElementById('product-add-form');

        async function loadProducts() {
            const res = await fetch('/api/products');
            const products = await res.json();
            productList.innerHTML = '';
            products.forEach(p => {
                productList.innerHTML += `<div class="item-container"><img src="${p.image}"><div class="item-info"><h3>${p.name}</h3><p>${p.price.toLocaleString('ko-KR')}원</p></div><button class="delete-btn" data-type="product" data-id="${p.id}">&times;</button></div>`;
            });
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productImageFile = document.getElementById('productImage').files[0];
            if (!productImageFile) return alert('상품 이미지를 선택해주세요.');

            const submitBtn = productForm.querySelector('button');
            submitBtn.innerHTML = '<span class="spinner"></span>';
            submitBtn.disabled = true;
            
            try {
                const cloudinaryRes = await uploadToCloudinary(productImageFile);
                
                const productData = {
                    productName: document.getElementById('productName').value,
                    productPrice: document.getElementById('productPrice').value,
                    productDescription: document.getElementById('productDescription').value,
                    productImage: cloudinaryRes.secure_url,
                    cloudinaryId: cloudinaryRes.public_id
                };
    
                await fetch('/admin/product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
    
                productForm.reset();
                // 상품 추가 후 미리보기 영역을 초기화
                productPreview.innerHTML = '';
                loadProducts();
            } catch (error) {
                console.error('An error occurred during product creation.');
            } finally {
                submitBtn.textContent = '상품 추가하기';
                submitBtn.disabled = false;
            }
        });

        // --- Delete Logic ---
        document.querySelector('.admin-container').addEventListener('click', async (e) => {
            if (e.target.classList.contains('preview-delete-btn')) {
                const fileIdToRemove = e.target.dataset.fileId;
                if (fileIdToRemove) {
                    // 갤러리 미리보기 삭제
                    galleryFiles = galleryFiles.filter(f => f.id != fileIdToRemove);
                } else {
                    // 상품 미리보기 삭제
                    document.getElementById('productImage').value = '';
                }
                e.target.parentElement.remove();
                return;
            }

            if (!e.target.classList.contains('delete-btn')) return;

            const type = e.target.dataset.type;
            if (type === 'image') {
                if (!confirm('갤러리 이미지를 정말 삭제하시겠습니까?')) return;
                await fetch(`/api/images/${encodeURIComponent(e.target.dataset.publicId)}`, { method: 'DELETE' });
                loadGallery();
            } else if (type === 'product') {
                if (!confirm('상품을 정말 삭제하시겠습니까?')) return;
                await fetch(`/api/products/${e.target.dataset.id}`, { method: 'DELETE' });
                loadProducts();
            } else if (type === 'blog') {
                if (!confirm('블로그 포스트를 정말 삭제하시겠습니까?')) return;
                await fetch(`/api/blog/posts/${e.target.dataset.id}`, { method: 'DELETE' });
                loadBlogPosts();
            }
        });

        // --- Blog Management ---
        const blogList = document.getElementById('blog-list');
        const blogForm = document.getElementById('blog-add-form');
        const blogThumbnailInput = document.getElementById('blogThumbnail');
        const blogThumbnailPreview = document.getElementById('blog-thumbnail-preview');
        const editingPostIdInput = document.getElementById('editingPostId');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        async function loadBlogPosts() {
            const res = await fetch('/api/blog/posts');
            const posts = await res.json();
            blogList.innerHTML = '';
            
            if (posts.length === 0) {
                blogList.innerHTML = '<p>작성된 블로그 포스트가 없습니다.</p>';
                return;
            }
            
            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'blog-post-card';
                
                const contentPreview = post.content.replace(/<[^>]*>/g, '').substring(0, 100) + '...';
                const createdDate = new Date(post.created_at).toLocaleDateString('ko-KR');
                const views = post.views || 0;
                
                card.innerHTML = `
                    <div class="blog-post-info">
                        <h3>${post.title}</h3>
                        <p>${contentPreview}</p>
                        <p><strong>작성일:</strong> ${createdDate}</p>
                        <p><strong>조회수:</strong> ${views.toLocaleString('ko-KR')}회</p>
                    </div>
                    <div class="blog-post-actions">
                        <button class="edit-btn" data-id="${post.id}">수정</button>
                        <button class="delete-btn" data-type="blog" data-id="${post.id}">삭제</button>
                    </div>
                `;
                blogList.appendChild(card);
            });
        }

        blogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('blogTitle').value;
            const content = quill.root.innerHTML;
            const thumbnailFile = blogThumbnailInput.files[0];
            const editingPostId = editingPostIdInput.value;
            
            if (!title || !content || content === '<p><br></p>') {
                alert('제목과 내용을 입력해주세요.');
                return;
            }
            
            const submitBtn = blogForm.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner"></span>';
            submitBtn.disabled = true;
            
            try {
                let thumbnailUrl = null;
                if (thumbnailFile) {
                    const cloudinaryRes = await uploadToCloudinary(thumbnailFile);
                    thumbnailUrl = cloudinaryRes.secure_url;
                }
                
                const blogData = {
                    title: title,
                    content: content,
                    thumbnail: thumbnailUrl
                };
                
                let response;
                if (editingPostId) {
                    // 수정
                    response = await fetch(`/api/blog/posts/${editingPostId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(blogData)
                    });
                } else {
                    // 신규 작성
                    response = await fetch('/api/blog/posts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(blogData)
                    });
                }
                
                if (response.ok) {
                    alert(editingPostId ? '포스트가 수정되었습니다.' : '포스트가 발행되었습니다.');
                    blogForm.reset();
                    quill.setContents([]);
                    blogThumbnailPreview.innerHTML = '';
                    editingPostIdInput.value = '';
                    cancelEditBtn.style.display = 'none';
                    submitBtn.textContent = '포스트 발행하기';
                    loadBlogPosts();
                } else {
                    alert('포스트 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('블로그 포스트 저장 오류:', error);
                alert('오류가 발생했습니다.');
            } finally {
                submitBtn.textContent = editingPostId ? '포스트 수정하기' : '포스트 발행하기';
                submitBtn.disabled = false;
            }
        });

        // 블로그 포스트 수정 버튼 클릭
        blogList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const postId = e.target.dataset.id;
                
                try {
                    const res = await fetch(`/api/blog/posts/${postId}`);
                    const post = await res.json();
                    
                    document.getElementById('blogTitle').value = post.title;
                    quill.root.innerHTML = post.content;
                    editingPostIdInput.value = post.id;
                    
                    blogForm.querySelector('button[type="submit"]').textContent = '포스트 수정하기';
                    cancelEditBtn.style.display = 'block';
                    
                    // 폼으로 스크롤
                    blogForm.scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('포스트 로딩 오류:', error);
                    alert('포스트를 불러오는데 실패했습니다.');
                }
            }
        });

        // 수정 취소 버튼
        cancelEditBtn.addEventListener('click', () => {
            blogForm.reset();
            quill.setContents([]);
            blogThumbnailPreview.innerHTML = '';
            editingPostIdInput.value = '';
            cancelEditBtn.style.display = 'none';
            blogForm.querySelector('button[type="submit"]').textContent = '포스트 발행하기';
        });

        // 블로그 썸네일 미리보기
        blogThumbnailInput.addEventListener('change', () => {
            blogThumbnailPreview.innerHTML = '';
            if (blogThumbnailInput.files.length > 0) {
                const file = blogThumbnailInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.createElement('div');
                    container.className = 'preview-image-container';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'preview-delete-btn';
                    deleteBtn.textContent = 'X';
                    deleteBtn.onclick = () => {
                        blogThumbnailInput.value = '';
                        blogThumbnailPreview.innerHTML = '';
                    };
                    
                    container.appendChild(img);
                    container.appendChild(deleteBtn);
                    blogThumbnailPreview.appendChild(container);
                }
                reader.readAsDataURL(file);
            }
        });

        // --- Init ---
        loadGallery();
        loadProducts();
        loadBlogPosts();

        // --- File Input Display ---
        const galleryInput = document.getElementById('gallery-files-input');
        galleryInput.addEventListener('change', () => {
            galleryPreview.innerHTML = '';
            galleryFiles = [];
            
            if (galleryInput.files.length > 0) {
                Array.from(galleryInput.files).forEach((file, index) => {
                    const fileId = `${Date.now()}-${index}`;
                    file.id = fileId;
                    galleryFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const container = document.createElement('div');
                        container.className = 'preview-image-container';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'preview-delete-btn';
                        deleteBtn.textContent = 'X';
                        deleteBtn.dataset.fileId = fileId;
                        
                        container.appendChild(img);
                        container.appendChild(deleteBtn);
                        galleryPreview.appendChild(container);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        const productInput = document.getElementById('productImage');
        const productPreview = document.getElementById('product-preview');
        productInput.addEventListener('change', () => {
            productPreview.innerHTML = '';
            if (productInput.files.length > 0) {
                const file = productInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.createElement('div');
                    container.className = 'preview-image-container';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'preview-delete-btn';
                    deleteBtn.textContent = 'X';

                    container.appendChild(img);
                    container.appendChild(deleteBtn);
                    productPreview.appendChild(container);
                }
                reader.readAsDataURL(file);
            }
        });

        // --- AI Agent Management ---
        const topicList = document.getElementById('topic-list');
        const topicForm = document.getElementById('topic-add-form');
        const generateNowBtn = document.getElementById('generate-now-btn');

        // 에이전트 상태 로드
        async function loadAgentStatus() {
            try {
                const res = await fetch('/api/blog/agent-status');
                const status = await res.json();

                document.getElementById('agent-enabled-status').textContent = status.isEnabled ? '활성화' : '비활성화';
                document.getElementById('agent-schedule-time').textContent = status.scheduleTime || '설정 안됨';
                document.getElementById('agent-unused-topics').textContent = `${status.unusedTopicsCount} / ${status.totalTopicsCount}`;
                document.getElementById('agent-last-run').textContent = status.lastRun 
                    ? new Date(status.lastRun).toLocaleString('ko-KR') 
                    : '없음';
            } catch (error) {
                console.error('에이전트 상태 로드 오류:', error);
            }
        }

        // 주제 목록 로드
        async function loadTopics() {
            try {
                const res = await fetch('/api/blog/topics');
                const topics = await res.json();
                topicList.innerHTML = '';

                if (topics.length === 0) {
                    topicList.innerHTML = '<p>등록된 주제가 없습니다.</p>';
                    return;
                }

                topics.forEach(topic => {
                    const card = document.createElement('div');
                    card.className = 'blog-post-card';
                    card.style.opacity = topic.used ? '0.6' : '1';

                    const usedDate = topic.used_at ? new Date(topic.used_at).toLocaleDateString('ko-KR') : '';

                    card.innerHTML = `
                        <div class="blog-post-info">
                            <h3>${topic.topic} ${topic.used ? '✓' : ''}</h3>
                            <p><strong>키워드:</strong> ${topic.keywords || '없음'}</p>
                            <p><strong>상태:</strong> ${topic.used ? `사용됨 (${usedDate})` : '미사용'}</p>
                        </div>
                        <div class="blog-post-actions">
                            <button class="delete-btn" data-type="topic" data-id="${topic.id}">삭제</button>
                        </div>
                    `;
                    topicList.appendChild(card);
                });
            } catch (error) {
                console.error('주제 로드 오류:', error);
            }
        }

        // 주제 추가
        topicForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const topic = document.getElementById('topicTitle').value;
            const keywords = document.getElementById('topicKeywords').value;

            try {
                const res = await fetch('/api/blog/topics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, keywords })
                });

                if (res.ok) {
                    topicForm.reset();
                    loadTopics();
                    loadAgentStatus();
                } else {
                    alert('주제 추가에 실패했습니다.');
                }
            } catch (error) {
                console.error('주제 추가 오류:', error);
                alert('오류가 발생했습니다.');
            }
        });

        // 블로그 즉시 생성
        generateNowBtn.addEventListener('click', async () => {
            if (!confirm('블로그 포스트를 지금 생성하시겠습니까? (1-2분 소요)')) return;

            generateNowBtn.innerHTML = '<span class="spinner"></span> 생성 중...';
            generateNowBtn.disabled = true;

            try {
                const res = await fetch('/api/blog/auto-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await res.json();

                if (result.success) {
                    alert(`블로그 포스트가 생성되었습니다!\n제목: ${result.title}`);
                    loadTopics();
                    loadAgentStatus();
                    loadBlogPosts();
                } else {
                    alert(`생성 실패: ${result.error || '알 수 없는 오류'}`);
                }
            } catch (error) {
                console.error('블로그 생성 오류:', error);
                alert('오류가 발생했습니다.');
            } finally {
                generateNowBtn.textContent = '지금 생성하기';
                generateNowBtn.disabled = false;
            }
        });



        // 주제 삭제 (기존 삭제 이벤트 리스너에 추가)
        document.addEventListener('click', async (e) => {
            if (e.target.dataset.type === 'topic' && e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                if (!confirm('이 주제를 삭제하시겠습니까?')) return;

                try {
                    const res = await fetch(`/api/blog/topics/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadTopics();
                        loadAgentStatus();
                    } else {
                        const errorData = await res.json();
                        console.error('삭제 실패 응답:', errorData);
                        alert(`삭제에 실패했습니다: ${errorData.error || '알 수 없는 오류'}`);
                    }
                } catch (error) {
                    console.error('삭제 오류:', error);
                    alert('오류가 발생했습니다: ' + error.message);
                }
            }
        });

        // AI 에이전트 탭 클릭 시 상태 로드
        document.querySelectorAll('.tab-link').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.dataset.tab === 'agent-management') {
                    loadAgentStatus();
                    loadTopics();
                }
            });
        });
    });
    </script>
</body>
</html> 